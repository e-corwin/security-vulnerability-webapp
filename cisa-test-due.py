import requests
import json
from datetime import date, datetime, timedelta

cisa_api = requests.get('https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json')
cisa_data = json.loads(cisa_api.content)

with open(f"cisa_data.json", "w") as outfile:
    json.dump(cisa_data, outfile, indent = 2)

title = cisa_data['title']
print(title)


# Finding Today's Date
todays_date = datetime.today()
todays_date_string = todays_date.strftime("%Y-%m-%d")
print("Today's Date:" , todays_date_string)
str(todays_date)
 
week_after_date = todays_date + timedelta(weeks = 1) 
print("Week after date: ", week_after_date)

number = len(cisa_data['vulnerabilities'])
print(number)

due_in_week_dict = {"vulnerabilities": []}
print(due_in_week_dict)
print("---")

# Due date has to be greater than today and less than 1 week from today
i = 1

# Converts the due date string into a date type with format YYYY-MM-DD
due_date_datetype = datetime.strptime(cisa_data['vulnerabilities'][i]['dueDate'], "%Y-%m-%d")
due_in_week_dict['vulnerabilities'] = cisa_data['vulnerabilities'][i]
#print("length of dict" , len(due_in_week_dict['vulnerabilities']))
#print(due_in_week_dict)
#print(due_in_week_dict['vulnerabilities'][1]['cveID'])

# Finding for Due in 1 Week
while i < number:
    if due_date_datetype >= todays_date and due_date_datetype <= week_after_date:
        print(cisa_data['vulnerabilities'][i]['vulnerabilityName'], "is due in the next week")
        print(due_date_datetype)
        print("-------")
        #j = len(due_in_week_dict['vulnerabilities']) + 1
        #print("length of dict" , j)
        #due_in_week_dict['vulnerabilities'] = cisa_data['vulnerabilities'][j]
        #print(due_in_week_dict)
    due_date_datetype = datetime.strptime(cisa_data['vulnerabilities'][i]['dueDate'], "%Y-%m-%d")
    i = i + 1
    # print(due_in_week_dict)
    # print("------")


# Finding for Due in 1 Month 

# Finding for Overdue
i = 1
# Converts the due date string into a date type with format YYYY-MM-DD
due_date_datetype = datetime.strptime(cisa_data['vulnerabilities'][i]['dueDate'], "%Y-%m-%d")
while i < number:
    if due_date_datetype < todays_date:
        print("----")
        print(cisa_data['vulnerabilities'][i]['dueDate'])
        print(cisa_data['vulnerabilities'][i]['vulnerabilityName'], "is overdue")
    
    due_date_datetype = datetime.strptime(cisa_data['vulnerabilities'][i]['dueDate'], "%Y-%m-%d")
    i = i + 1
    

