from flask import Flask, render_template, request
import json
from filtering_data import cveFiltering, cisaFiltering

app = Flask(__name__)

@app.route("/", methods=['GET', 'POST'])
def home():

    f = open('./cve-data-full.json')
    DATA_CVE = json.load(f)
    f = open('./cisa-data-full.json')
    DATA_CISA = json.load(f)

    number = len(DATA_CISA['vulnerabilities'])

    # Creating List of Vendors for Vendor Dropdown
    vendor_list= []
    i = 0
    while i < number:
        vendor = DATA_CISA['vulnerabilities'][i]['vendorProject']
        if vendor not in vendor_list:
            vendor_list.append(vendor)
        i = i + 1
    vendor_list = sorted(vendor_list, key=str.lower)

    # Gets Filter Values from the Form
    form = request.method
    newest = request.args.get("time")
    severity = request.args.get("severity")
    vendor = request.args.get("vendor")
    filter_list = [newest, severity, vendor]

    # Runs 'filtering' algorithms
    filtered_cve = cveFiltering(DATA_CVE, newest, severity, vendor)
    filtered_cisa = cisaFiltering(DATA_CISA, newest, severity, vendor)
    num_entries = str(len(filtered_cve['vulnerabilities']) + len(filtered_cisa['vulnerabilities']))
    
    return render_template("home.html", vendors=vendor_list, filteredCVE=filtered_cve, filteredCISA=filtered_cisa, filters=filter_list, numberEntries=num_entries)


if __name__ == "__main__":
    app.run(debug=True, port=8003)