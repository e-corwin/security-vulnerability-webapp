import requests
import json
from datetime import date, datetime, timedelta
from dateutil.relativedelta import relativedelta
from update_data import updateCVE

cve_data = updateCVE()
test = cve_data['vulnerabilities'][0]['cve']
print(test)
cve_keys_to_remove = ['sourceIdentifier', 'cisaExploitAdd', 'cisaActionDue']
for key in cve_keys_to_remove:
    test.pop(key, None)
del test['descriptions'][0]['lang']
del test['descriptions'][1]['lang']
del test['weaknesses']
del test['configurations']
del test['references']
del test['metrics']['cvssMetricV2'][0]['source']
del test['metrics']['cvssMetricV2'][0]['metric']
del test['metrics']['cvssMetricV2']['type']

# for key in keys:
 #   test['metrics']['cvssMetricV2'][0].pop(key, None)


print("----")
print(test)

with open(f"testing.json", "w") as outfile:
    json.dump(test, outfile, indent = 2)
'''

def cveModifiedToday():
    cve_data = updateCVE()

    # Finding Today's Date
    todays_date = datetime.today()
    todays_date_string = todays_date.strftime("%Y-%m-%d")
    print("Today's Date:" , todays_date_string)
    str(todays_date)

    length_cve_data = len(cve_data['vulnerabilities'])
    print(length_cve_data)

    added_today_dict = {}
    added_today_dict['addedToday'] = []

    # ADDED TODAY
    i = 1

    # Converts the due date string into a date type with format YYYY-MM-DD
    add_date_datetype = cve_data['vulnerabilities'][0]['cve']['lastModified']

    # Add date has to be less than today and greater than 1 week from today
    i = 0

    while i < length_cve_data:
        if add_date_datetype == todays_date:
            added_today_dict['addedToday'].append(cve_data['vulnerabilities'][i])
        add_date_datetype = cve_data['vulnerabilities'][i]['cve']['lastModified']
        

    with open(f"cve_added_today_dict.json", "w") as outfile:
        json.dump(added_today_dict, outfile, indent = 2)

    return added_today_dict


def cveModifiedOneWeek():
    cve_data = updateCVE()

    # Finding Today's Date
    
    todays_date = datetime.today()
    todays_date_string = todays_date.strftime("%Y-%m-%d")
    #print("Today's Date:" , todays_date_string)
    str(todays_date)
    
    week_before_date = todays_date - timedelta(weeks = 1) 
    
    #print("Week before date: ", week_before_date)

    length_cve_data = len(cve_data['vulnerabilities'])
    #print(length_cve_data)

    length_cve_data = len(cve_data['vulnerabilities'])

    add_in_week_dict = {}
    add_in_week_dict['recentlyAdded'] = []

    # ADDED IN THE LAST WEEK

    # Add date has to be less than today and greater than 1 week from today
    i = 1

    # Converts the due date string into a date type with format YYYY-MM-DD
    cve_add_date_datatype = cve_data['vulnerabilities'][i]['cve']['lastModified']
    cve_add_date_string = cve_add_date_datatype[:10]
    cve_add_date_datetime = datetime.strptime(cve_add_date_string, "%Y-%m-%d")

    # Add date has to be less than today and greater than 1 week from today
    i = 0

    while i < length_cve_data:
        if cve_add_date_datetime <= todays_date and cve_add_date_datetime >= week_before_date:
            add_in_week_dict['recentlyAdded'].append(cve_data['vulnerabilities'][i])
        cve_add_date_datatype = cve_data['vulnerabilities'][i]['cve']['lastModified']
        cve_add_date_string = cve_add_date_datatype[:10]
        cve_add_date_datetime = datetime.strptime(cve_add_date_string, "%Y-%m-%d")
        i = i + 1

    with open(f"cve_recently_added_dict.json", "w") as outfile:
        json.dump(add_in_week_dict, outfile, indent = 2)

    return add_in_week_dict


def cveModifiedOneMonth():
    cve_data = updateCVE()

    # Finding Today's Date
    todays_date = datetime.today()
    todays_date_string = todays_date.strftime("%Y-%m-%d")
    print("Today's Date:" , todays_date_string)
    str(todays_date)
    
    month_before_date = todays_date - relativedelta(months=1) 
    print("Month before date: ", month_before_date)

    length_cve_data = len(cve_data['vulnerabilities'])
    print(length_cve_data)

    add_in_month_dict = {}
    add_in_month_dict['recentlyAdded'] = []

    # ADDED IN THE LAST MONTH

    # Add date has to be less than today and greater than 1 month from today
    i = 1

    # Converts the due date string into a date type with format YYYY-MM-DD
    cve_add_date_datetype = cve_data['vulnerabilities'][i]['cve']['lastModified']
    cve_add_date_string = cve_add_date_datetype[:10]
    cve_add_date_datetime = datetime.strptime(cve_add_date_string, "%Y-%m-%d")
    
    # Add date has to be less than today and greater than 1 week from today
    i = 0

    while i < length_cve_data:
        if cve_add_date_datetime <= todays_date and cve_add_date_datetime >= month_before_date:
            add_in_month_dict['recentlyAdded'].append(cve_data['vulnerabilities'][i])
        cve_add_date_datetype = cve_data['vulnerabilities'][i]['cve']['lastModified']
        cve_add_date_string = cve_add_date_datetype[:10]
        cve_add_date_datetime = datetime.strptime(cve_add_date_string, "%Y-%m-%d")
        i = i + 1

    with open(f"cve_recently_added_dict.json", "w") as outfile:
        json.dump(add_in_month_dict, outfile, indent = 2)

    return add_in_month_dict
'''